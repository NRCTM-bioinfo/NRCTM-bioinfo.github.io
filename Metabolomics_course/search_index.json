[["index.html", "生信分析系列培训课程（第2期） Chapter 1 Metabolomics Data Analysis", " 生信分析系列培训课程（第2期） Tuantuan Gui and Xuan Liu 2023-11-23 Chapter 1 Metabolomics Data Analysis 转化中心生信大数据平台内部资料，请勿外传，谢谢！ "],["install-mnet-package.html", "Chapter 2 install MNet package", " Chapter 2 install MNet package The R package MNet requires R version 4.0.0 or higher, please see https://cran.r-project.org. 相关依赖包安装 if(!require(&quot;BiocManager&quot;)){install.packages(&quot;BiocManager&quot;)} library(BiocManager) if(!require(&quot;Biobase&quot;)){BiocManager::install(&quot;Biobase&quot;)} if(!require(&quot;BiocStyle&quot;)){BiocManager::install(&quot;BiocStyle&quot;)} if(!require(&quot;BiocGenerics&quot;)){BiocManager::install(&quot;BiocGenerics&quot;)} if(!require(&quot;ropls&quot;)){BiocManager::install(&quot;ropls&quot;)} if(!require(&quot;pheatmap&quot;)){install.packages(&quot;pheatmap&quot;)} if(!require(&quot;pacman&quot;)){install.packages(&quot;pacman&quot;)} library(pacman) p_load(readxl,ggplot2,fgsea,limma,reshape2,dnet,dplyr,stats,pathview,survival,igraph,caret,xgboost,graphite,e1071,magrittr,vegan,stringr,survminer,pROC,randomForest,jsonlite,tibble,utils,tidyr,grDevices,ggpubr,graph,ggrepel,Boruta,filesstrings,methods,tidyselect,AnnotationDbi,rmarkdown,RUnit) MNet 安装 BiocManager::install(&quot;remotes&quot;, dependencies=T) BiocManager::install(&quot;devtools &quot;, dependencies=T) BiocManager::install(&quot;tuantuangui/MNet&quot;, dependencies=T) # 安装成功即可运行MNet library(MNet) "],["数据前处理.html", "Chapter 3 数据前处理 3.1 代谢物鉴定 3.2 代谢物名称统一 3.3 批次矫正", " Chapter 3 数据前处理 3.1 代谢物鉴定 Level 1为通过参考标准品在相同分析条件下确证的化合物，包括匹配保留时间（RT）、一级（MS1）和二级（MS2）； Level 2为通过文献/公共库检索所得或者可能的断裂方式推测所得化合物； Level 3为根据某类化合物的特定碎片所推断的一类化合物； Level 4为根据质谱信息（例如：加和离子、同位素峰、碎片信息等）推测出分子式的化合物； Level 5为分离得到、有精确质荷比（m/z）且感兴趣的未知化合物。 3.2 代谢物名称统一 library(MNet) compound_name &lt;- c(&quot;1 Methylhistidine&quot;,&quot;1-Methylhistidine&quot;,&quot;L-1-Methylhistidine&quot;,&quot;N1-Methyl-L-histidine&quot;) ## 统一代谢物名称 result &lt;- MNet::name2refmet(compound_name) ## 代谢物名称转换为KEGGID name2keggid(&quot;1-Methylhistidine&quot;) ## 代谢物对应的通路 result_pathway &lt;- name2pathway(&quot;1-Methylhistidine&quot;) result_pathway$name2pathway result_pathway$kegg_id result_pathway$pathway 3.3 批次矫正 3.3.1 data for SERRF SERRF采用随机森林的方法来对非靶向代谢组学数据进行归一化,需要将下机数据转换为SERRF校正所需的格式才能进行归一化.准备好相应格式的文件后直接在SERRF网站上加载并进行归一化处理. library(dplyr) # Set result path out.path &lt;- file.path(&quot;result&quot;) out.path dir.create( out.path ) # 输入原始数据并转换为数据框 meta.data &lt;- readxl::read_excel(&quot;raw_data/meta_data.xlsx&quot;) %&gt;% as.data.frame() sample_order &lt;- readxl::read_excel(&quot;raw_data/sample_order.xls&quot;) %&gt;% as.data.frame() # 把数据调成SERRF所需的格式 overlap_sample &lt;- intersect(names(meta.data),sample_order$sample) qc_intersect_filter &lt;- sample_order %&gt;% dplyr::filter(sample %in% overlap_sample) %&gt;% dplyr::arrange(time) qc_intersect_filter$time &lt;- seq(1,nrow(qc_intersect_filter)) meta.data_filter &lt;- meta.data %&gt;% dplyr::select(c(&quot;label&quot;,qc_intersect_filter$sample)) batch &lt;- c(&quot;batch&quot;,qc_intersect_filter$batch) sampleType &lt;- c(&quot;sampleType&quot;,qc_intersect_filter$sampleType) time &lt;- c(&quot;time&quot;,qc_intersect_filter$time) label &lt;- c(colnames(meta.data_filter)) all_result_temp &lt;- rbind(batch,sampleType,time,label,meta.data_filter) number &lt;- c(&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;No&quot;,c(1:(nrow(meta.data_filter)))) serrf_data &lt;- cbind(number,all_result_temp) write.table(serrf_data,&quot;result/02.test_for_serrf.txt&quot;,quote=F,row.names=F,sep=&quot;\\t&quot;,col.names = T) 输入原始数据文件并转换为数据框 meta.data sample_order 输出符合serrf的格式的文件:02.test_for_serrf 3.3.2 对SERRF校正前后的数据进行PCA分析 library(dplyr) library(ggplot2) # SERRF校正前 before_normalization_raw &lt;- data.table::fread(&quot;raw_data/test_for_serrf.txt&quot;) %&gt;% as.data.frame() before_normalization &lt;- before_normalization_raw %&gt;% t() %&gt;% as.data.frame() %&gt;% filter(!V4 %in% c(&quot;No&quot;,&quot;label&quot;)) names(before_normalization) &lt;- as.character(before_normalization_raw[,2]) names(before_normalization)[4] &lt;- &quot;sample_id&quot; # pca before_batch &lt;- as.character(before_normalization_raw[1,-c(1,2)]) before_type &lt;- as.character(before_normalization_raw[2,-c(1,2)]) before_sample_id &lt;- as.character(before_normalization_raw[4,-c(1,2)]) dd &lt;- data.frame(type=before_type,batch=before_batch,sample_id=before_sample_id) mydata_pca &lt;- apply(before_normalization[,5:ncol(before_normalization)],2,as.numeric) pca &lt;- prcomp(log2(mydata_pca+1), center = T, scale. = T) variance = pca$sdev^2/sum(pca$sdev^2) pca.data = data.frame(pca$x,type=before_type,batch=before_batch,sample_id=before_sample_id) p1 &lt;- ggplot(pca.data,aes(PC1,PC2,color=type,shape=before_batch))+ geom_point()+ scale_color_manual(values=c(&quot;red&quot;,&quot;#3e68a0&quot;))+ scale_shape_manual(values=seq(0,length(unique(before_batch))-1))+ #geom_text(aes(label=sample_id))+ theme_bw()+ theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())+ labs(x=paste0(&quot;PC1 (&quot;,signif(variance[1]*100,3),&quot;%)&quot;), y=paste0(&quot;PC2 (&quot;,signif(variance[2]*100,3),&quot;%)&quot;)) # SERRF校正后 after_normalization_raw &lt;- read.csv(&quot;SERRF/normalized by - SERRF.csv&quot;) %&gt;% as.data.frame() %&gt;% dplyr::distinct(label,.keep_all = T) %&gt;% tibble::column_to_rownames(&quot;label&quot;) %&gt;% t() %&gt;% as.data.frame() %&gt;% tibble::rownames_to_column(var=&quot;sample&quot;) %&gt;% dplyr::mutate(sample=gsub(&quot;X&quot;,&quot;&quot;,sample)) %&gt;% tibble::column_to_rownames(&quot;sample&quot;) after_sample_id &lt;- rownames(after_normalization_raw) after_dd &lt;- data.frame(sample_id=after_sample_id) %&gt;% dplyr::left_join(dd,by=&quot;sample_id&quot;) mydata_pca &lt;- apply(after_normalization_raw,2,as.numeric) pca &lt;- prcomp(log2(mydata_pca+1), center = T, scale. = T) variance = pca$sdev^2/sum(pca$sdev^2) pca.data = cbind(pca$x,after_dd) p2 &lt;- ggplot(pca.data,aes(PC1,PC2,color=type,shape=batch))+ geom_point()+ scale_color_manual(values=c(&quot;red&quot;,&quot;#3e68a0&quot;))+ scale_shape_manual(values=seq(0,1))+ #geom_text(aes(label=sample_id))+ theme_bw()+ theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())+ labs(x=paste0(&quot;PC1 (&quot;,signif(variance[1]*100,3),&quot;%)&quot;), y=paste0(&quot;PC2 (&quot;,signif(variance[2]*100,3),&quot;%)&quot;)) ggsave(&quot;result/02.pca_raw.pdf&quot;,p1,width=5,height = 3.9) ggsave(&quot;result/02.pca_normalization.pdf&quot;,p2,width=5,height = 3.9) ggsave(&quot;result/02.pca_raw.png&quot;,p1,width=5,height = 3.9) ggsave(&quot;result/02.pca_normalization.png&quot;,p2,width=5,height = 3.9) pca_raw pca_normalization 3.3.3 data filter 相对标准偏差(relative standard deviation,RSD) 是一种广泛使用的指标，通过将标准偏差除以算术平均值来计算QC中的每种代谢物i。这使得在所有可检测的代谢物中具有可比性的无单位和标准化测量。RSD越小代表代谢物越集中。通常需舍弃RSD超过30%的信号峰(数据质量太差). library(dplyr) library(ggplot2) dat_raw &lt;- data.table::fread(&quot;SERRF/QC-RSDs.csv&quot;) %&gt;% as.data.frame() ## 需要对样品进行质控，通常需舍弃RSD超过30%的信号峰(数据质量太差) dat_rsd &lt;- dat_raw %&gt;% dplyr::filter(SERRF &lt;= 0.3) #读取SERRF归一化后的数据 data_filter &lt;- data.table::fread(&quot;SERRF/normalized by - SERRF.csv&quot;) %&gt;% as.data.frame() %&gt;% dplyr::filter(label %in% dat_rsd$label) %&gt;% dplyr::select(&quot;label&quot;,starts_with(&quot;sample&quot;)) write.table(data_filter,&quot;result/02.dat_filter.txt&quot;,quote=F,row.names=F,sep=&quot;\\t&quot;) # 可视化SERRF校正前后的数据 dat_melt &lt;- reshape2::melt(dat_raw,id=&quot;label&quot;) %&gt;% dplyr::mutate(variable=ifelse(variable==&quot;none&quot;,&quot;Raw&quot;,&quot;Normalization&quot;)) %&gt;% dplyr::mutate(variable=factor(variable,levels = c(&quot;Raw&quot;,&quot;Normalization&quot;))) p &lt;- ggplot(dat_melt,aes(x=variable,y=value))+ geom_violin(col=&quot;#D01910&quot;,width=.5)+ geom_jitter(width=.2,col=&quot;#00599F&quot;)+ theme_bw()+ labs(x=NULL,y=&quot;RSD&quot;) ggsave(&quot;result/02.RSD.pdf&quot;,p,width=5,height = 3) ggsave(&quot;result/02.RSD.png&quot;,p,width=5,height = 3) SERRF校正前后的对比 "],["差异代谢物.html", "Chapter 4 差异代谢物 4.1 PCA 4.2 limma 4.3 OPLS-DA 4.4 可视化", " Chapter 4 差异代谢物 library(dplyr) library(ggplot2) library(MNet) 4.1 PCA 主成分分析(Principal Component Analysis，PCA)：是从原始变量之间的相互关系入手，根据变异最大化的原则将其线性变换到几个独立的综合指标上（即主成分），取2～3个主成分作图,直观地描述不同组别之间的代谢模式差别和聚类结果,并通过载荷图寻找对组间分类有贡献的原始变量作为生物标志物. dir.create(&quot;result&quot;) ## 操作者需根据自己的数据更改tumor-normal组名称及对应样本数 group &lt;- c(rep(&quot;tumor&quot;,24),rep(&quot;normal&quot;,7)) # meta_dat是 MNet R包内的一个数据框 View(meta_dat) ## 对代谢组数据根据分组进行主成分分析 p_out &lt;- pPCA(meta_dat,group) ggsave(&quot;result/03.PCA_p1.pdf&quot;,p_out$p1,width=5,height = 3.9) ggsave(&quot;result/03.PCA_p2.pdf&quot;,p_out$p2,width=5,height = 3.9) ggsave(&quot;result/03.PCA_p3.pdf&quot;,p_out$p3,width=8,height = 6) ggsave(&quot;result/03.PCA_p1.png&quot;,p_out$p1,width=5,height = 3.9) ggsave(&quot;result/03.PCA_p2.png&quot;,p_out$p2,width=5,height = 3.9) ggsave(&quot;result/03.PCA_p3.png&quot;,p_out$p3,width=8,height = 6) PCA_p1 PCA_p2 PCA_p3 4.2 limma limma分析可用于代谢组及转录组差异分析. result_mlimma_all &lt;- mlimma(meta_dat,group) write.table(result_mlimma_all,&quot;result/03.result_mlimma_all.txt&quot;,quote=F,row.names=F,sep=&quot;\\t&quot;) 4.3 OPLS-DA 正交-偏最小二乘判别分(OPLS-DA)使用正交信号校正技术，将X矩阵信息分解成与Y相关和不相关的两类信息，然后过滤掉与分类无关的信息，相关的信息主要集中在第一个预测成分. 通常,根据 VIP(Variable Importance for the Projection)值来说明变量(特征峰)能解释X数据集和关联Y数据集的重要性.所有VIP值的平方之和与模型中的变量总数相等,因此,其平均值为1.当某个变量的VIP&gt;1时，说明该变量是重要的，通常将此作为潜在生物标记物对筛选条件之一. ## fold change, p value and VIP of the data result_DM_all &lt;- DM(2**meta_dat,group) write.table(result_DM_all,&quot;result/03.result_DM_all.txt&quot;,quote=F,row.names=F,sep=&quot;\\t&quot;) 4.4 可视化 4.4.1 Heatmap result_mlimma_filter &lt;- result_mlimma_all %&gt;% dplyr::filter(abs(logFC) &gt; 1) %&gt;% dplyr::filter(`adj.P.Val` &lt; 0.05) dat_filter &lt;- meta_dat %&gt;% tibble::rownames_to_column(var=&quot;label&quot;) %&gt;% dplyr::filter(label %in% result_mlimma_filter$name) %&gt;% tibble::column_to_rownames(&quot;label&quot;) %&gt;% head(n=10) pdf(&quot;result/03.p_heatmap.pdf&quot;,width=5,height = 5) p_heatmap &lt;- MNet::pHeatmap(dat_filter,group,clustering_distance_cols =&quot;manhattan&quot;, clustering_method=&quot;ward.D&quot;,fontsize_row=3) dev.off() png(&quot;result/03.p_heatmap.png&quot;, width = 8, height = 7, units = &#39;in&#39;, res = 200 ) p_heatmap &lt;- MNet::pHeatmap(dat_filter,group,clustering_distance_cols =&quot;manhattan&quot;, clustering_method=&quot;ward.D&quot;,fontsize_row=3) dev.off() p_heatmap 4.4.2 Volcano Plot p_Volcano &lt;- pVolcano(result_DM_all,foldchange_threshold = 1.5,p_threshold = 0.01) ggsave(&quot;result/03.p_valocano.pdf&quot;,p_Volcano,width=5,height = 4) ggsave(&quot;result/03.p_valocano.png&quot;,p_Volcano,width=5,height = 4) p_valocano 4.4.3 Z-score Z-score(标准分数)是基于代谢物的相对含量转换而来的值，用于衡量同一水平面上代谢物的相对含量的高低. p_Zscore &lt;- pZscore(dat_filter,group) ggsave(&quot;result/03.p_Zscore.pdf&quot;,p_Zscore,width=3,height = 1.5) ggsave(&quot;result/03.p_Zscore.png&quot;,p_Zscore,width=3,height = 1.5) p_Zscore "],["pathway分析.html", "Chapter 5 Pathway分析 5.1 Pathway Enrichment Analysis 5.2 Differential Abundance Analysis 5.3 MSEA", " Chapter 5 Pathway分析 library(dplyr) library(ggplot2) library(MNet) 5.1 Pathway Enrichment Analysis KEGG通路分析，包括基因和代谢物的扩展通路分析. dat_increase &lt;- result_mlimma_all %&gt;% dplyr::filter(logFC &gt; 0.58) %&gt;% dplyr::filter(P.Value &lt; 0.05) dat_decrease &lt;- result_mlimma_all %&gt;% dplyr::filter(logFC &lt; -0.58) %&gt;% dplyr::filter(P.Value &lt; 0.05) kegg_all &lt;- unique(c(dat_increase$name,dat_decrease$name)) pathway_result &lt;- PathwayAnalysis(kegg_all,out=&quot;metabolite&quot;) ggsave(&quot;result/04.pathway_enrichment.pdf&quot;,pathway_result$p_barplot,width = 8,height = 5) ggsave(&quot;result/04.pathway_enrichment.png&quot;,pathway_result$p_barplot,width = 8,height = 5) pathway_enrichment 5.2 Differential Abundance Analysis result_da &lt;- DAscore(dat_increase$name,dat_decrease$name,result_mlimma_all$name,out=&quot;metabolite&quot; ) View(result_da$result) ggsave(&quot;result/04.DA_DA-score.pdf&quot;,result_da$p,width = 8,height = 10) ggsave(&quot;result/04.DA_DA-score.png&quot;,result_da$p,width = 8,height = 10) result_da2 &lt;- DAscore(dat_increase$name,dat_decrease$name,result_mlimma_all$name,sort_plot = &quot;category&quot;,out=&quot;metabolite&quot; ) ggsave(&quot;result/04.DA_pathway-category.pdf&quot;,result_da2$p,width = 8,height = 10) ggsave(&quot;result/04.DA_pathway-category.png&quot;,result_da2$p,width = 8,height = 10) DA_DA-score DA_pathway-category 5.3 MSEA Metabolite Set Enrichment Analysis dd_arrange &lt;- result_mlimma_all %&gt;% dplyr::arrange(logFC) d_logFC &lt;- dd_arrange$logFC names(d_logFC) &lt;- dd_arrange$name result_msea &lt;- MSEA(d_logFC) result_msea &lt;- result_msea %&gt;% dplyr::mutate(leadingEdge=as.character(leadingEdge)) write.table(result_msea,&quot;result/04.MSEA.txt&quot;,quote=F,row.names=F,sep=&quot;\\t&quot;) ## 想看哪个通路就输入哪个通路名字 p_MSEA &lt;- pMSEA(&quot;Pyrimidine metabolism&quot;,d_logFC) ggsave(&quot;result/04.p_MSEA_pyrimidine.pdf&quot;,p_MSEA,width=5,height = 4) ggsave(&quot;result/04.p_MSEA_pyrimidine.png&quot;,p_MSEA,width=5,height = 4) p_MSEA &lt;- pMSEA(&quot;Fatty acid biosynthesis&quot;,d_logFC) ggsave(&quot;result/04.p_MSEA_fatty.pdf&quot;,p_MSEA,width=5,height = 4) ggsave(&quot;result/04.p_MSEA_fatty.png&quot;,p_MSEA,width=5,height = 4) p_MSEA_pyrimidine p_MSEA_fatty "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
